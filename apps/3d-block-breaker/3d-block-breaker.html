<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ブロック崩し</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            background: linear-gradient(to bottom, #0a0a0a, #1a0a2e, #0f0326);
        }
        #gameCanvas {
            display: block;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ffff;
            font-size: 24px;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 100;
            font-weight: bold;
            letter-spacing: 2px;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0088;
            font-size: 48px;
            text-align: center;
            text-shadow: 0 0 20px #ff0088, 0 0 40px #ff0088, 3px 3px 6px rgba(0,0,0,0.9);
            display: none;
            z-index: 200;
            font-weight: bold;
            letter-spacing: 3px;
        }
        #message button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 24px;
            background: linear-gradient(45deg, #ff0088, #00ffff);
            border: 2px solid #00ffff;
            border-radius: 5px;
            cursor: pointer;
            color: #0a0a0a;
            font-weight: bold;
            box-shadow: 0 0 20px #00ffff, 0 4px 8px rgba(0,0,0,0.3);
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            transition: all 0.3s;
        }
        #message button:hover {
            background: linear-gradient(45deg, #00ffff, #ff0088);
            box-shadow: 0 0 30px #ff0088, 0 4px 12px rgba(0,0,0,0.5);
            transform: scale(1.05);
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ffff;
            font-size: 16px;
            text-align: center;
            text-shadow: 0 0 10px #00ffff, 2px 2px 4px rgba(0,0,0,0.8);
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div>スコア: <span id="score">0</span></div>
        <div>ライフ: <span id="lives">3</span></div>
        <div>ステージ: <span id="stage">1</span></div>
    </div>
    <div id="message">
        <div id="messageText"></div>
        <button id="restartBtn" onclick="restartGame()">再スタート</button>
    </div>
    <div id="controls">
        ← → キーで左右移動 | ↑ ↓ キーで前後移動 | スペースキーでゲーム開始/一時停止
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ゲーム設定
        const config = {
            paddleSpeed: 0.3,
            ballSpeed: 0.15,
            lives: 3,
            blockRows: 4,
            blockCols: 8,
            blockLayers: 3
        };

        // Three.js 基本設定
        let scene, camera, renderer;
        let paddle, ball, blocks = [];
        let ballShadowIndicator;  // ボールの影表示用
        let ballVelocity = { x: 0, y: 0, z: 0 };
        let keys = {};
        let gameState = 'ready'; // ready, playing, paused, gameover, stageclear
        let score = 0;
        let lives = config.lives;
        let stage = 1;

        // 初期化
        function init() {
            // シーン作成（サイバーパンク風）
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x0a0a0a, 10, 50);
            scene.background = new THREE.Color(0x0a0a0a);

            // カメラ作成
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, -8, 12);
            camera.lookAt(0, 0, 0);

            // レンダラー作成
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // ライト追加（サイバーパンク風ネオンライト）
            const ambientLight = new THREE.AmbientLight(0x220044, 0.3);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xff0088, 0.6);
            directionalLight.position.set(5, 10, 7);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const pointLight1 = new THREE.PointLight(0x00ffff, 2, 50);
            pointLight1.position.set(-8, 5, 5);
            scene.add(pointLight1);
            
            const pointLight2 = new THREE.PointLight(0xff0088, 2, 50);
            pointLight2.position.set(8, 5, 5);
            scene.add(pointLight2);

            // ゲームオブジェクト作成
            createPaddle();
            createBall();
            createBallShadowIndicator();
            createBlocks();
            createWalls();

            // イベントリスナー
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            // ゲームループ開始
            animate();
        }

        // ボールの影インジケーター作成（サイバーパンク風）
        function createBallShadowIndicator() {
            const geometry = new THREE.CircleGeometry(0.5, 32);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff,  // シアン（サイバーパンクカラー）
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            ballShadowIndicator = new THREE.Mesh(geometry, material);
            ballShadowIndicator.rotation.x = -Math.PI / 2;
            ballShadowIndicator.position.y = -7.5;  // 地面の位置
            scene.add(ballShadowIndicator);
        }

        // パドル作成（立体的な厚みのあるパドル・サイバーパンク風）
        function createPaddle() {
            const geometry = new THREE.BoxGeometry(2, 0.4, 2);  // x, y, z - 立体的な厚み
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x00ff88,
                emissive: 0x00ff88,
                shininess: 100
            });
            paddle = new THREE.Mesh(geometry, material);
            paddle.position.set(0, -6, 1);  // z位置を中央に
            paddle.castShadow = true;
            scene.add(paddle);
            
            // パドルにネオンエッジを追加
            const edgeGeometry = new THREE.EdgesGeometry(geometry);
            const edgeMaterial = new THREE.LineBasicMaterial({ color: 0x00ffff, linewidth: 2 });
            const edges = new THREE.LineSegments(edgeGeometry, edgeMaterial);
            paddle.add(edges);
        }

        // ボール作成（サイバーパンク風の発光効果付き）
        function createBall() {
            const geometry = new THREE.SphereGeometry(0.4, 32, 32);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0xff0033,  // 鮮やかな赤
                emissive: 0xff0033,  // 赤の発光
                shininess: 100
            });
            ball = new THREE.Mesh(geometry, material);
            resetBall();
            ball.castShadow = true;
            scene.add(ball);
            
            // ポイントライト（ボールから赤い光を発する）
            const ballLight = new THREE.PointLight(0xff0033, 3, 8);
            ball.add(ballLight);
        }

        // ボールリセット
        function resetBall() {
            ball.position.set(0, -5, 0);
            ballVelocity = { x: 0, y: 0, z: 0 };
        }

        // ブロック作成（サイバーパンク風ネオンブロック）
        function createBlocks() {
            blocks.forEach(block => scene.remove(block));
            blocks = [];

            const blockWidth = 1.2;
            const blockHeight = 0.5;
            const blockDepth = 0.8;
            const spacing = 0.2;

            const colors = [
                0xff0088,  // ネオンピンク
                0x00ffff,  // シアン
                0xff00ff,  // マゼンタ
                0x00ff88,  // ネオングリーン
                0xff8800,  // オレンジ
                0x8800ff,  // パープル
                0xffff00   // イエロー
            ];

            for (let layer = 0; layer < config.blockLayers; layer++) {
                for (let row = 0; row < config.blockRows; row++) {
                    for (let col = 0; col < config.blockCols; col++) {
                        const geometry = new THREE.BoxGeometry(blockWidth, blockHeight, blockDepth);
                        const color = colors[(row + layer) % colors.length];
                        const material = new THREE.MeshPhongMaterial({ 
                            color: color,
                            emissive: color,
                            emissiveIntensity: 0.5,
                            shininess: 100
                        });
                        const block = new THREE.Mesh(geometry, material);
                        
                        const x = (col - config.blockCols / 2) * (blockWidth + spacing) + (blockWidth + spacing) / 2;
                        const y = row * (blockHeight + spacing) + 1;
                        const z = layer * (blockDepth + spacing);
                        
                        block.position.set(x, y, z);
                        block.castShadow = true;
                        
                        // ネオンエッジを追加
                        const edgeGeometry = new THREE.EdgesGeometry(geometry);
                        const edgeMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 1 });
                        const edges = new THREE.LineSegments(edgeGeometry, edgeMaterial);
                        block.add(edges);
                        
                        blocks.push(block);
                        scene.add(block);
                    }
                }
            }
        }

        // 壁作成（サイバーパンク風ネオングリッド）
        function createWalls() {
            const wallMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                transparent: true, 
                opacity: 0.15,
                wireframe: true
            });

            // 左右の壁
            const sideWallGeometry = new THREE.BoxGeometry(0.1, 20, 10);
            const leftWall = new THREE.Mesh(sideWallGeometry, wallMaterial);
            leftWall.position.set(-6, 0, 0);
            scene.add(leftWall);

            const rightWall = new THREE.Mesh(sideWallGeometry, wallMaterial);
            rightWall.position.set(6, 0, 0);
            scene.add(rightWall);

            // 上の壁
            const topWallGeometry = new THREE.BoxGeometry(12, 0.1, 10);
            const topWall = new THREE.Mesh(topWallGeometry, wallMaterial);
            topWall.position.set(0, 6, 0);
            scene.add(topWall);

            // 奥の壁
            const backWallGeometry = new THREE.BoxGeometry(12, 20, 0.1);
            const backWall = new THREE.Mesh(backWallGeometry, wallMaterial);
            backWall.position.set(0, 0, 3);
            scene.add(backWall);
            
            // グリッドヘルパー（サイバーパンク風の床グリッド）
            const gridHelper = new THREE.GridHelper(12, 24, 0xff0088, 0x00ffff);
            gridHelper.position.y = -7.5;
            gridHelper.material.opacity = 0.3;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);
        }

        // キー入力処理
        function onKeyDown(event) {
            keys[event.key] = true;
            
            if (event.key === ' ') {
                event.preventDefault();
                if (gameState === 'ready') {
                    startGame();
                } else if (gameState === 'playing') {
                    gameState = 'paused';
                    showMessage('一時停止中<br>スペースキーで再開');
                } else if (gameState === 'paused') {
                    gameState = 'playing';
                    hideMessage();
                }
            }
        }

        function onKeyUp(event) {
            keys[event.key] = false;
        }

        // ゲーム開始
        function startGame() {
            gameState = 'playing';
            hideMessage();
            
            // ボールに初期速度を与える
            const angle = (Math.random() - 0.5) * Math.PI / 3;
            ballVelocity.x = Math.sin(angle) * config.ballSpeed;
            ballVelocity.y = config.ballSpeed;
            ballVelocity.z = (Math.random() - 0.5) * config.ballSpeed * 0.3;
        }

        // ゲーム更新
        function update() {
            if (gameState !== 'playing') return;

            // パドル移動（左右とZ軸の上下）
            if (keys['ArrowLeft'] && paddle.position.x > -5) {
                paddle.position.x -= config.paddleSpeed;
            }
            if (keys['ArrowRight'] && paddle.position.x < 5) {
                paddle.position.x += config.paddleSpeed;
            }
            if (keys['ArrowUp'] && paddle.position.z > -0.5) {  // Z軸で手前に移動
                paddle.position.z -= config.paddleSpeed;
            }
            if (keys['ArrowDown'] && paddle.position.z < 2.5) {  // Z軸で奥に移動
                paddle.position.z += config.paddleSpeed;
            }

            // ボール移動
            ball.position.x += ballVelocity.x;
            ball.position.y += ballVelocity.y;
            ball.position.z += ballVelocity.z;
            
            // 影インジケーターをボールのX,Z位置に追従させる
            if (ballShadowIndicator) {
                ballShadowIndicator.position.x = ball.position.x;
                ballShadowIndicator.position.z = ball.position.z;
            }

            // 壁との衝突判定
            if (ball.position.x <= -5.7 || ball.position.x >= 5.7) {
                ballVelocity.x *= -1;
                ball.position.x = Math.max(-5.7, Math.min(5.7, ball.position.x));
            }
            if (ball.position.y >= 5.7) {
                ballVelocity.y *= -1;
                ball.position.y = 5.7;
            }
            if (ball.position.z <= -0.3 || ball.position.z >= 2.7) {
                ballVelocity.z *= -1;
                ball.position.z = Math.max(-0.3, Math.min(2.7, ball.position.z));
            }

            // パドルとの衝突判定
            if (checkCollision(ball, paddle)) {
                ballVelocity.y = Math.abs(ballVelocity.y);  // 上向きに跳ね返す
                
                // パドルの位置に応じてボールの角度を変える
                const relativeX = (ball.position.x - paddle.position.x) / 1;
                const relativeZ = (ball.position.z - paddle.position.z) / 1;
                ballVelocity.x = relativeX * config.ballSpeed * 1.5;
                ballVelocity.z = relativeZ * config.ballSpeed * 0.5;
                
                ball.position.y = paddle.position.y + 0.5;  // パドルの上に配置
            }

            // ブロックとの衝突判定
            for (let i = blocks.length - 1; i >= 0; i--) {
                if (checkCollision(ball, blocks[i])) {
                    // ブロック削除
                    scene.remove(blocks[i]);
                    blocks.splice(i, 1);
                    
                    // スコア加算
                    score += 10;
                    updateUI();
                    
                    // ボール反射
                    ballVelocity.y *= -1;
                    
                    // 全ブロック破壊チェック
                    if (blocks.length === 0) {
                        stageClear();
                    }
                    break;
                }
            }

            // ボールを取り逃した場合
            if (ball.position.y < -8) {
                lives--;
                updateUI();
                
                if (lives <= 0) {
                    gameOver();
                } else {
                    resetBall();
                    gameState = 'ready';
                    showMessage('スペースキーでボール発射');
                }
            }
        }

        // 衝突判定
        function checkCollision(obj1, obj2) {
            const box1 = new THREE.Box3().setFromObject(obj1);
            const box2 = new THREE.Box3().setFromObject(obj2);
            return box1.intersectsBox(box2);
        }

        // ステージクリア
        function stageClear() {
            gameState = 'stageclear';
            stage++;
            score += 100;
            updateUI();
            showMessage(`ステージ ${stage - 1} クリア！<br>スペースキーで次のステージ`);
            
            // 次のステージ準備
            setTimeout(() => {
                createBlocks();
                resetBall();
                gameState = 'ready';
            }, 2000);
        }

        // ゲームオーバー
        function gameOver() {
            gameState = 'gameover';
            showMessage(`ゲームオーバー<br>最終スコア: ${score}`);
        }

        // ゲーム再スタート
        function restartGame() {
            score = 0;
            lives = config.lives;
            stage = 1;
            gameState = 'ready';
            updateUI();
            createBlocks();
            resetBall();
            paddle.position.set(0, -6, 1);
            hideMessage();
            showMessage('スペースキーでゲーム開始');
        }

        // UI更新
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('stage').textContent = stage;
        }

        // メッセージ表示
        function showMessage(text) {
            const messageDiv = document.getElementById('message');
            const messageText = document.getElementById('messageText');
            messageText.innerHTML = text;
            messageDiv.style.display = 'block';
            
            if (gameState === 'gameover' || gameState === 'ready') {
                document.getElementById('restartBtn').style.display = 'inline-block';
            } else {
                document.getElementById('restartBtn').style.display = 'none';
            }
        }

        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }

        // アニメーションループ
        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        // ウィンドウリサイズ対応
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ゲーム開始
        init();
        showMessage('スペースキーでゲーム開始');
    </script>
</body>
</html>
