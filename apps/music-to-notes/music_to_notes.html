<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¥½ã‹ã‚‰éŸ³ç¬¦ã¸ã®å¤‰æ›ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            user-select: none;
        }

        #startBtn {
            background: #4CAF50;
            color: white;
        }

        #startBtn:hover {
            background: #45a049;
        }

        #startBtn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        #stopBtn {
            background: #f44336;
            color: white;
        }

        #stopBtn:hover {
            background: #da190b;
        }

        #stopBtn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .current-note {
            text-align: center;
            margin: 30px 0;
            padding: 40px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
        }

        .current-note h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .note-display {
            font-size: 4em;
            font-weight: bold;
            margin: 10px 0;
        }

        .frequency-display {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .note-history {
            margin-top: 30px;
        }

        .note-history h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .notes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .note-item {
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }

        .status.recording {
            background: #4CAF50;
            color: white;
        }

        .status.stopped {
            background: #f44336;
            color: white;
        }

        .visualizer {
            margin: 20px 0;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 10px;
        }

        .staff-notation {
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .staff-notation h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        #staffCanvas {
            width: 100%;
            border-radius: 8px;
            background: white;
        }

        canvas {
            width: 100%;
            border-radius: 8px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ éŸ³æ¥½ã‹ã‚‰éŸ³ç¬¦ã¸ã®å¤‰æ›</h1>
        
        <div class="controls">
            <button id="startBtn">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
            <button id="stopBtn" disabled>â¹ï¸ éŒ²éŸ³åœæ­¢</button>
        </div>

        <div class="visualizer">
            <canvas id="visualizer" width="720" height="100"></canvas>
        </div>

        <div class="current-note">
            <h2>ç¾åœ¨ã®éŸ³ç¬¦</h2>
            <div class="note-display" id="noteDisplay">--</div>
            <div class="frequency-display" id="frequencyDisplay">å‘¨æ³¢æ•°: -- Hz</div>
        </div>

        <div class="staff-notation">
            <h3>äº”ç·šè­œ</h3>
            <canvas id="staffCanvas" width="1200" height="300"></canvas>
        </div>

        <div class="note-history">
            <h3>æ¤œå‡ºã•ã‚ŒãŸéŸ³ç¬¦ã®å±¥æ­´</h3>
            <div class="notes-container" id="notesContainer">
                <p style="color: #999;">éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹ã¨ã€æ¤œå‡ºã•ã‚ŒãŸéŸ³ç¬¦ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
        </div>

        <div class="status stopped" id="status">åœæ­¢ä¸­</div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let scriptProcessor;
        let isRecording = false;
        let notesHistory = [];
        let lastNote = '';

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const noteDisplay = document.getElementById('noteDisplay');
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        const notesContainer = document.getElementById('notesContainer');
        const status = document.getElementById('status');
        const visualizerCanvas = document.getElementById('visualizer');
        const visualizerCtx = visualizerCanvas.getContext('2d');
        const staffCanvas = document.getElementById('staffCanvas');
        const staffCtx = staffCanvas.getContext('2d');

        let staffNotes = []; // äº”ç·šè­œã«è¡¨ç¤ºã™ã‚‹éŸ³ç¬¦ã®é…åˆ—
        const maxStaffNotes = 20; // äº”ç·šè­œã«è¡¨ç¤ºã™ã‚‹æœ€å¤§éŸ³ç¬¦æ•°

        // éŸ³ç¬¦åã¨MIDIç•ªå·ã®å¯¾å¿œï¼ˆãƒ‰ãƒ¬ãƒŸè¡¨è¨˜ã®ã¿ï¼‰
        const doremiStrings = ['ãƒ‰', 'ãƒ‰#', 'ãƒ¬', 'ãƒ¬#', 'ãƒŸ', 'ãƒ•ã‚¡', 'ãƒ•ã‚¡#', 'ã‚½', 'ã‚½#', 'ãƒ©', 'ãƒ©#', 'ã‚·'];

        // å‘¨æ³¢æ•°ã‹ã‚‰MIDIç•ªå·ã‚’è¨ˆç®—
        function frequencyToMidi(frequency) {
            return 12 * Math.log2(frequency / 440) + 69;
        }

        // MIDIç•ªå·ã‹ã‚‰éŸ³ç¬¦åã‚’å–å¾—ï¼ˆãƒ‰ãƒ¬ãƒŸè¡¨è¨˜ï¼‰
        function midiToNoteName(midi) {
            const noteIndex = Math.round(midi) % 12;
            const octave = Math.floor(Math.round(midi) / 12) - 1;
            return doremiStrings[noteIndex] + octave;
        }

        // äº”ç·šè­œã‚’æç”»
        function drawStaff() {
            const width = staffCanvas.width;
            const height = staffCanvas.height;
            const lineSpacing = 20;
            const startY = height / 2 - lineSpacing * 2;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            staffCtx.clearRect(0, 0, width, height);
            staffCtx.fillStyle = 'white';
            staffCtx.fillRect(0, 0, width, height);
            
            // äº”ç·šã‚’æç”»
            staffCtx.strokeStyle = '#333';
            staffCtx.lineWidth = 2;
            
            for (let i = 0; i < 5; i++) {
                const y = startY + i * lineSpacing;
                staffCtx.beginPath();
                staffCtx.moveTo(40, y);
                staffCtx.lineTo(width - 40, y);
                staffCtx.stroke();
            }
            
            // ãƒˆéŸ³è¨˜å·ã‚’æç”»ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            staffCtx.font = 'bold 60px serif';
            staffCtx.fillStyle = '#333';
            staffCtx.fillText('ğ„', 50, startY + lineSpacing * 3);
            
            // éŸ³ç¬¦ã‚’æç”»
            if (staffNotes.length > 0) {
                const noteWidth = (width - 200) / maxStaffNotes;
                
                staffNotes.forEach((noteData, index) => {
                    const x = 150 + index * noteWidth;
                    drawNote(x, noteData, startY, lineSpacing);
                });
            }
        }

        // éŸ³ç¬¦ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆMIDIç•ªå·ã‹ã‚‰äº”ç·šè­œä¸Šã®Yåº§æ¨™ã‚’è¨ˆç®—ï¼‰
        function getNoteY(midi, startY, lineSpacing) {
            // C4(ãƒŸãƒ‰ãƒ«C, MIDI 60)ã‚’åŸºæº–ã¨ã™ã‚‹
            const c4Position = startY + lineSpacing * 5; // ç¬¬1ç·šã®ä¸‹
            const halfStep = lineSpacing / 2;
            const stepsFromC4 = midi - 60;
            return c4Position - (stepsFromC4 * halfStep);
        }

        // éŸ³ç¬¦ã‚’æç”»
        function drawNote(x, noteData, startY, lineSpacing) {
            const y = getNoteY(noteData.midi, startY, lineSpacing);
            const noteRadius = 8;
            
            // éŸ³ç¬¦ã®ä¸¸ï¼ˆé»’å¡—ã‚Šï¼‰
            staffCtx.fillStyle = '#333';
            staffCtx.beginPath();
            staffCtx.ellipse(x, y, noteRadius, noteRadius * 0.8, -20 * Math.PI / 180, 0, 2 * Math.PI);
            staffCtx.fill();
            
            // éŸ³ç¬¦ã®æ£’
            staffCtx.strokeStyle = '#333';
            staffCtx.lineWidth = 2;
            staffCtx.beginPath();
            staffCtx.moveTo(x + noteRadius - 2, y);
            staffCtx.lineTo(x + noteRadius - 2, y - 40);
            staffCtx.stroke();
            
            // åŠ ç·šãŒå¿…è¦ãªå ´åˆ
            const lineY = Math.round((y - startY) / lineSpacing) * lineSpacing + startY;
            if (y < startY - lineSpacing || y > startY + lineSpacing * 4 + lineSpacing) {
                staffCtx.strokeStyle = '#333';
                staffCtx.lineWidth = 2;
                
                // ä¸Šã®åŠ ç·š
                if (y < startY) {
                    for (let ly = startY - lineSpacing; ly >= y - lineSpacing / 2; ly -= lineSpacing) {
                        staffCtx.beginPath();
                        staffCtx.moveTo(x - 12, ly);
                        staffCtx.lineTo(x + 12, ly);
                        staffCtx.stroke();
                    }
                }
                
                // ä¸‹ã®åŠ ç·š
                if (y > startY + lineSpacing * 4) {
                    for (let ly = startY + lineSpacing * 5; ly <= y + lineSpacing / 2; ly += lineSpacing) {
                        staffCtx.beginPath();
                        staffCtx.moveTo(x - 12, ly);
                        staffCtx.lineTo(x + 12, ly);
                        staffCtx.stroke();
                    }
                }
            }
            
            // ã‚·ãƒ£ãƒ¼ãƒ—è¨˜å·
            if (noteData.isSharp) {
                staffCtx.font = 'bold 20px serif';
                staffCtx.fillStyle = '#333';
                staffCtx.fillText('â™¯', x - 20, y + 5);
            }
            
            // éŸ³ç¬¦åã‚’ä¸‹ã«è¡¨ç¤ºï¼ˆãƒ‰ãƒ¬ãƒŸã®ã¿ï¼‰
            staffCtx.font = '12px sans-serif';
            staffCtx.fillStyle = '#666';
            staffCtx.textAlign = 'center';
            staffCtx.fillText(noteData.noteName, x, startY + lineSpacing * 5 + 30);
        }

        // åˆæœŸæç”»
        drawStaff();

        // è‡ªå·±ç›¸é–¢ã‚’ä½¿ã£ãŸåŸºæœ¬å‘¨æ³¢æ•°æ¤œå‡º
        function autoCorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let best_offset = -1;
            let best_correlation = 0;
            let rms = 0;
            let foundGoodCorrelation = false;

            // RMSã‚’è¨ˆç®—ï¼ˆéŸ³é‡ãƒã‚§ãƒƒã‚¯ï¼‰
            for (let i = 0; i < SIZE; i++) {
                const val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / SIZE);
            
            // éŸ³ãŒå°ã•ã™ãã‚‹å ´åˆã¯-1ã‚’è¿”ã™
            if (rms < 0.01) return -1;

            // è‡ªå·±ç›¸é–¢ã‚’è¨ˆç®—
            let lastCorrelation = 1;
            for (let offset = 1; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;

                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs((buffer[i]) - (buffer[i + offset]));
                }
                
                correlation = 1 - (correlation / MAX_SAMPLES);
                
                if (correlation > 0.9 && correlation > lastCorrelation) {
                    foundGoodCorrelation = true;
                    if (correlation > best_correlation) {
                        best_correlation = correlation;
                        best_offset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    const shift = (buffer[best_offset + 1] - buffer[best_offset - 1]) / buffer[best_offset];
                    return sampleRate / (best_offset + (8 * shift));
                }
                lastCorrelation = correlation;
            }
            
            if (best_correlation > 0.01) {
                return sampleRate / best_offset;
            }
            return -1;
        }

        // æ³¢å½¢ã‚’å¯è¦–åŒ–
        function drawWaveform(dataArray) {
            visualizerCtx.fillStyle = 'white';
            visualizerCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
            
            visualizerCtx.lineWidth = 2;
            visualizerCtx.strokeStyle = '#667eea';
            visualizerCtx.beginPath();

            const sliceWidth = visualizerCanvas.width / dataArray.length;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * visualizerCanvas.height / 2;

                if (i === 0) {
                    visualizerCtx.moveTo(x, y);
                } else {
                    visualizerCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            visualizerCtx.lineTo(visualizerCanvas.width, visualizerCanvas.height / 2);
            visualizerCtx.stroke();
        }

        // éŸ³ç¬¦ã‚’å±¥æ­´ã«è¿½åŠ 
        function addNoteToHistory(note, frequency, midi) {
            if (note === lastNote) return;
            
            lastNote = note;
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            notesHistory.unshift({ note, frequency, timestamp });
            
            // æœ€æ–°50å€‹ã¾ã§ä¿æŒ
            if (notesHistory.length > 50) {
                notesHistory.pop();
            }
            
            // äº”ç·šè­œç”¨ã®éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const noteIndex = Math.round(midi) % 12;
            const isSharp = doremiStrings[noteIndex].includes('#');
            
            staffNotes.push({
                midi: Math.round(midi),
                noteName: note,
                isSharp: isSharp
            });
            
            // æœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„éŸ³ç¬¦ã‚’å‰Šé™¤
            if (staffNotes.length > maxStaffNotes) {
                staffNotes.shift();
            }
            
            updateNotesDisplay();
            drawStaff();
        }

        // éŸ³ç¬¦å±¥æ­´ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateNotesDisplay() {
            if (notesHistory.length === 0) return;
            
            notesContainer.innerHTML = notesHistory.map(item => {
                return `
                    <div class="note-item">
                        <strong>${item.note}</strong> 
                        <span style="color: #666;">(${item.frequency.toFixed(1)} Hz)</span>
                        <br>
                        <small style="color: #999;">${item.timestamp}</small>
                    </div>
                `;
            }).join('');
        }

        startBtn.addEventListener('click', async () => {
            console.log('Start button clicked');
            
            // Check if browser supports getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒã‚¤ã‚¯æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Firefoxã€Edgeãªã©ã®æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                status.textContent = 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...';
                status.className = 'status recording';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                console.log('Microphone access granted');
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                analyser.fftSize = 2048;
                const bufferLength = analyser.fftSize;
                const dataArray = new Float32Array(bufferLength);
                const timeDataArray = new Uint8Array(bufferLength);

                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                scriptProcessor.onaudioprocess = function() {
                    analyser.getFloatTimeDomainData(dataArray);
                    analyser.getByteTimeDomainData(timeDataArray);
                    
                    drawWaveform(timeDataArray);
                    
                    const frequency = autoCorrelate(dataArray, audioContext.sampleRate);
                    
                    if (frequency > 0 && frequency < 4000) {
                        const midi = frequencyToMidi(frequency);
                        const note = midiToNoteName(midi);
                        
                        noteDisplay.textContent = note;
                        frequencyDisplay.textContent = `å‘¨æ³¢æ•°: ${frequency.toFixed(2)} Hz`;
                        
                        addNoteToHistory(note, frequency, midi);
                    }
                };

                isRecording = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                status.textContent = 'éŒ²éŸ³ä¸­';
                status.className = 'status recording';
                notesContainer.innerHTML = '<p style="color: #999;">éŸ³ã‚’å‡ºã—ã¦ãã ã•ã„...</p>';
                
            } catch (err) {
                console.error('Error:', err);
                let errorMsg = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMsg += 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (err.name === 'NotReadableError') {
                    errorMsg += 'ãƒã‚¤ã‚¯ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                } else {
                    errorMsg += err.message;
                }
                
                alert(errorMsg);
                status.textContent = 'åœæ­¢ä¸­';
                status.className = 'status stopped';
            }
        });

        stopBtn.addEventListener('click', () => {
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            if (analyser) {
                analyser.disconnect();
                analyser = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            isRecording = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = 'åœæ­¢ä¸­';
            status.className = 'status stopped';
            noteDisplay.textContent = '--';
            frequencyDisplay.textContent = 'å‘¨æ³¢æ•°: -- Hz';
            lastNote = '';
            
            // äº”ç·šè­œã¯ã‚¯ãƒªã‚¢ã›ãšã«ä¿æŒ
        });
    </script>
</body>
</html>
